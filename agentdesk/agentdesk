#!/usr/bin/env python3
"""
AgentDesk CLI - Command Line Interface for Agent Organization Management

Usage:
    agentdesk init                          # Initialize a new organization
    agentdesk desk add <config>             # Add a new agent desk
    agentdesk desk list                     # List all desks
    agentdesk task create <title>           # Create a new task
    agentdesk task assign <task_id> <desk>  # Assign task to desk
    agentdesk org show                      # Display organization chart
    agentdesk run                           # Start the task processing loop
"""

import asyncio
import json
import yaml
import sys
from pathlib import Path
from typing import Optional
import click
from rich.console import Console
from rich.table import Table
from rich.tree import Tree
from rich import print as rprint
from datetime import datetime

# Import from our core module (adjust path as needed)
# For standalone use, you may need to modify imports
import sys
from pathlib import Path

# Add the parent directory of src/core to the Python path
sys.path.insert(0, str(Path(__file__).resolve().parent / "src"))

from core.agent import (
    AgentDesk, AgentRole, LLMConfig, OrganizationStructure,
    Task, TaskStatus, Priority, DeskStatus,
    Team, Committee, QAPipelineStage, QAPipeline, WorkflowStep, Workflow,
    TaskRoutingRule, NotificationChannel, MetricsDashboard, MetricsConfig, AgentBehavior
)

console = Console()

# Global organization instance (in production, this would be in a database)
_org: Optional[OrganizationStructure] = None
_config_dir = Path.home() / ".agentdesk"
_org_file = _config_dir / "organization.json"


def load_organization() -> OrganizationStructure:
    """Load organization from config file"""
    global _org
    
    if _org is not None:
        return _org
    
    if not _org_file.exists():
        console.print("[red]No organization found. Run 'agentdesk init' first.[/red]")
        sys.exit(1)
    
    with open(_org_file, 'r') as f:
        data = json.load(f)
    
    org = OrganizationStructure(data['name'])
    
    # Recreate desks
    for desk_data in data.get('desks', []):
        llm_cfg = desk_data['llm_config']
        llm_config = LLMConfig(
            provider=llm_cfg['provider'],
            model=llm_cfg['model'],
            temperature=llm_cfg.get('temperature', 0.7),
            max_tokens=llm_cfg.get('max_tokens', 4000)
        )
        
        desk = AgentDesk(
            desk_id=desk_data['desk_id'],
            title=desk_data['title'],
            role=AgentRole(desk_data['role']),
            llm_config=llm_config,
            capabilities=desk_data.get('capabilities', []),
            hierarchy_level=desk_data.get('hierarchy_level', 0),
            reports_to=desk_data.get('reports_to'),
            team_id=desk_data.get('team_id')
        )
        org.add_desk(desk)
    
    # Recreate teams
    for team_data in data.get('teams', []):
        team = Team(
            team_id=team_data['team_id'],
            name=team_data['name'],
            lead=team_data['lead'],
            members=team_data['members'],
            focus=team_data.get('focus')
        )
        org.teams[team.team_id] = team

    # Recreate committees
    for committee_data in data.get('committees', []):
        committee = Committee(
            committee_id=committee_data['committee_id'],
            name=committee_data['name'],
            chair=committee_data['chair'],
            members=committee_data['members'],
            purpose=committee_data.get('purpose'),
            meeting_frequency=committee_data.get('meeting_frequency')
        )
        org.committees[committee.committee_id] = committee

    # Recreate QA Pipeline
    if 'qa_pipeline' in data and data['qa_pipeline']:
        qa_pipeline_data = data['qa_pipeline']
        stages = []
        for stage_data in qa_pipeline_data.get('stages', []):
            stage = QAPipelineStage(
                type=stage_data['type'],
                agent=stage_data.get('agent'),
                assignee_level=stage_data.get('assignee_level'),
                required_reviewers=stage_data.get('required_reviewers'),
                criteria=stage_data.get('criteria', []),
                timeout=stage_data.get('timeout'),
                block_on_critical=stage_data.get('block_on_critical'),
                required_for_types=stage_data.get('required_for_types', []),
                assessment_areas=stage_data.get('assessment_areas', []),
                frameworks=stage_data.get('frameworks', []),
                required_for_priority=stage_data.get('required_for_priority', []),
                approval_criteria=stage_data.get('approval_criteria', []),
                tools=stage_data.get('tools', [])
            )
            stages.append(stage)
        org.qa_pipeline = QAPipeline(
            enabled=qa_pipeline_data.get('enabled', True),
            required_for=qa_pipeline_data.get('required_for', []),
            stages=stages
        )

    # Recreate Workflows
    for workflow_id, workflow_data in data.get('workflows', {}).items():
        steps = []
        for step_data in workflow_data.get('steps', []):
            step = WorkflowStep(
                name=step_data['name'],
                assigned_role=step_data.get('assigned_role'),
                assigned_agent=step_data.get('assigned_agent'),
                committee=step_data.get('committee'),
                team=step_data.get('team'),
                outputs=step_data.get('outputs', []),
                inputs=step_data.get('inputs', []),
                condition=step_data.get('condition'),
                qa_required=step_data.get('qa_required', False),
                max_duration=step_data.get('max_duration'),
                verification_required=step_data.get('verification_required', False),
                tools=step_data.get('tools', []),
                focus_areas=step_data.get('focus_areas', []),
                test_types=step_data.get('test_types', []),
                required_for=step_data.get('required_for', [])
            )
            steps.append(step)
        workflow = Workflow(
            name=workflow_data['name'],
            trigger=workflow_data['trigger'],
            steps=steps,
            priority=workflow_data.get('priority')
        )
        org.workflows[workflow_id] = workflow

    # Recreate Task Routing Rules
    for rule_data in data.get('task_routing_rules', []):
        rule = TaskRoutingRule(
            keywords=rule_data.get('keywords', []),
            route_to=rule_data.get('route_to'),
            escalate_if_critical=rule_data.get('escalate_if_critical'),
            notify_committee=rule_data.get('notify_committee'),
            escalate_to=rule_data.get('escalate_to')
        )
        org.task_routing_rules.append(rule)

    # Recreate Notifications
    for channel_data in data.get('notifications', []):
        channel = NotificationChannel(
            type=channel_data['type'],
            webhook_url=channel_data.get('webhook_url'),
            recipients=channel_data.get('recipients', []),
            integration_key=channel_data.get('integration_key'),
            notify_on=channel_data.get('notify_on', [])
        )
        org.notifications.append(channel)

    # Recreate Metrics
    if 'metrics' in data and data['metrics']:
        metrics_data = data['metrics']
        dashboards = []
        for dashboard_data in metrics_data.get('dashboards', []):
            dashboard = MetricsDashboard(
                name=dashboard_data['name'],
                metrics=dashboard_data.get('metrics', []),
                refresh_interval=dashboard_data.get('refresh_interval')
            )
            dashboards.append(dashboard)
        org.metrics = MetricsConfig(
            track=metrics_data.get('track', []),
            dashboards=dashboards
        )

    # Recreate Agent Behaviors
    for agent_id, behavior_data in data.get('agent_behaviors', {}).items():
        behavior = AgentBehavior(
            communication_style=behavior_data.get('communication_style'),
            decision_making=behavior_data.get('decision_making'),
            escalation_threshold=behavior_data.get('escalation_threshold'),
            automation_preference=behavior_data.get('automation_preference'),
            negotiation_style=behavior_data.get('negotiation_style'),
            research_depth=behavior_data.get('research_depth'),
            ioc_extraction=behavior_data.get('ioc_extraction'),
            report_format=behavior_data.get('report_format'),
            documentation_level=behavior_data.get('documentation_level')
        )
        org.agent_behaviors[agent_id] = behavior

    _org = org
    return org


def save_organization(org: OrganizationStructure):
    """Save organization to config file"""
    _config_dir.mkdir(exist_ok=True)
    
    data = {
        'name': org.org_name,
        'desks': [desk.to_dict() for desk in org.desks.values()],
        'tasks': [task.to_dict() for task in org.tasks.values()],
        'teams': [team.to_dict() for team in org.teams.values()],
        'committees': [committee.to_dict() for committee in org.committees.values()],
        'qa_pipeline': org.qa_pipeline.to_dict() if org.qa_pipeline else None,
        'workflows': {wf_id: wf.to_dict() for wf_id, wf in org.workflows.items()},
        'task_routing_rules': [rule.to_dict() for rule in org.task_routing_rules],
        'notifications': [channel.to_dict() for channel in org.notifications],
        'metrics': org.metrics.to_dict() if org.metrics else None,
        'agent_behaviors': {agent_id: behavior.to_dict() for agent_id, behavior in org.agent_behaviors.items()},
        'saved_at': datetime.now().isoformat()
    }
    
    with open(_org_file, 'w') as f:
        json.dump(data, f, indent=2)
    
    console.print(f"[green]Organization saved to {_org_file}[/green]")


@click.group()
def cli():
    """AgentDesk - Hierarchical Multi-Agent AI Organization System"""
    pass


@cli.command()
@click.option('--name', help='Name of your organization')
@click.option('--from-file', type=click.Path(exists=True), help='Load from YAML config file')
def init(name: Optional[str], from_file: Optional[str]):
    """Initialize a new organization"""
    
    global _org

    if from_file:
        with open(from_file, 'r') as f:
            config = yaml.safe_load(f)
        
        org_name_from_file = config['organization']['name']
        org = OrganizationStructure(org_name_from_file)
        console.print(f"[yellow]DEBUG: Desks before loading: {len(org.desks)}[/yellow]")
        # Create desks from config
        for desk_cfg in config['organization'].get('desks', []):
            llm_cfg = desk_cfg['llm']
            llm_config = LLMConfig(
                provider=llm_cfg['provider'],
                model=llm_cfg['model'],
                temperature=llm_cfg.get('temperature', 0.7),
                max_tokens=llm_cfg.get('max_tokens', 4000)
            )
            
            desk = AgentDesk(
                desk_id=desk_cfg['id'],
                title=desk_cfg['title'],
                role=AgentRole(desk_cfg['role']),
                llm_config=llm_config,
                capabilities=desk_cfg.get('capabilities', []),
                hierarchy_level=desk_cfg.get('hierarchy_level', 0),
                reports_to=desk_cfg.get('reports_to'),
                team_id=desk_cfg.get('team_id')
            )
            org.add_desk(desk)
            console.print(f"[yellow]DEBUG: Added desk {desk.desk_id}. Current desks: {len(org.desks)}[/yellow]")

        # Load teams
        for team_cfg in config['teams']:
            team = Team(
                team_id=team_cfg['id'],
                name=team_cfg['name'],
                lead=team_cfg['lead'],
                members=team_cfg['members'],
                focus=team_cfg.get('focus')
            )
            org.teams[team.team_id] = team

        # Load committees
        for committee_cfg in config['committees']:
            committee = Committee(
                committee_id=committee_cfg['id'],
                name=committee_cfg['name'],
                chair=committee_cfg['chair'],
                members=committee_cfg['members'],
                purpose=committee_cfg.get('purpose'),
                meeting_frequency=committee_cfg.get('meeting_frequency')
            )
            org.committees[committee.committee_id] = committee

        # Load QA Pipeline
        if 'qa_pipeline' in config:
            qa_pipeline_cfg = config['qa_pipeline']
            stages = []
            for stage_cfg in qa_pipeline_cfg.get('stages', []):
                stage = QAPipelineStage(
                    type=stage_cfg['type'],
                    agent=stage_cfg.get('agent'),
                    assignee_level=stage_cfg.get('assignee_level'),
                    required_reviewers=stage_cfg.get('required_reviewers'),
                    criteria=stage_cfg.get('criteria', []),
                    timeout=stage_cfg.get('timeout'),
                    block_on_critical=stage_cfg.get('block_on_critical'),
                    required_for_types=stage_cfg.get('required_for_types', []),
                    assessment_areas=stage_cfg.get('assessment_areas', []),
                    frameworks=stage_cfg.get('frameworks', []),
                    required_for_priority=stage_cfg.get('required_for_priority', []),
                    approval_criteria=stage_cfg.get('approval_criteria', []),
                    tools=stage_cfg.get('tools', [])
                )
                stages.append(stage)
            org.qa_pipeline = QAPipeline(
                enabled=qa_pipeline_cfg.get('enabled', True),
                required_for=qa_pipeline_cfg.get('required_for', []),
                stages=stages
            )

        # Load Workflows
        if 'workflows' in config:
            for workflow_id, workflow_cfg in config['workflows'].items():
                steps = []
                for step_cfg in workflow_cfg.get('steps', []):
                    step = WorkflowStep(
                        name=step_cfg['name'],
                        assigned_role=step_cfg.get('assigned_role'),
                        assigned_agent=step_cfg.get('assigned_agent'),
                        committee=step_cfg.get('committee'),
                        team=step_cfg.get('team'),
                        outputs=step_cfg.get('outputs', []),
                        inputs=step_cfg.get('inputs', []),
                        condition=step_cfg.get('condition'),
                        qa_required=step_cfg.get('qa_required', False),
                        max_duration=step_cfg.get('max_duration'),
                        verification_required=step_cfg.get('verification_required', False),
                        tools=step_cfg.get('tools', []),
                        focus_areas=step_cfg.get('focus_areas', []),
                        test_types=step_cfg.get('test_types', []),
                        required_for=step_cfg.get('required_for', [])
                    )
                    steps.append(step)
                workflow = Workflow(
                    name=workflow_cfg['name'],
                    trigger=workflow_cfg['trigger'],
                    steps=steps,
                    priority=workflow_cfg.get('priority')
                )
                org.workflows[workflow_id] = workflow

        # Load Task Routing Rules
        if 'task_routing' in config:
            for rule_cfg in config['task_routing'].get('rules', []):
                rule = TaskRoutingRule(
                    keywords=rule_cfg.get('keywords', []),
                    route_to=rule_cfg.get('route_to'),
                    escalate_if_critical=rule_cfg.get('escalate_if_critical'),
                    notify_committee=rule_cfg.get('notify_committee'),
                    escalate_to=rule_cfg.get('escalate_to')
                )
                org.task_routing_rules.append(rule)

        # Load Notifications
        if 'notifications' in config:
            for channel_cfg in config['notifications'].get('channels', []):
                channel = NotificationChannel(
                    type=channel_cfg['type'],
                    webhook_url=channel_cfg.get('webhook_url'),
                    recipients=channel_cfg.get('recipients', []),
                    integration_key=channel_cfg.get('integration_key'),
                    notify_on=channel_cfg.get('notify_on', [])
                )
                org.notifications.append(channel)

        # Load Metrics
        if 'metrics' in config:
            metrics_cfg = config['metrics']
            dashboards = []
            for dashboard_cfg in metrics_cfg.get('dashboards', []):
                dashboard = MetricsDashboard(
                    name=dashboard_cfg['name'],
                    metrics=dashboard_cfg.get('metrics', []),
                    refresh_interval=dashboard_cfg.get('refresh_interval')
                )
                dashboards.append(dashboard)
            org.metrics = MetricsConfig(
                track=metrics_cfg.get('track', []),
                dashboards=dashboards
            )

        # Load Agent Behaviors
        if 'agent_behaviors' in config:
            for agent_id, behavior_cfg in config['agent_behaviors'].items():
                behavior = AgentBehavior(
                    communication_style=behavior_cfg.get('communication_style'),
                    decision_making=behavior_cfg.get('decision_making'),
                    escalation_threshold=behavior_cfg.get('escalation_threshold'),
                    automation_preference=behavior_cfg.get('automation_preference'),
                    negotiation_style=behavior_cfg.get('negotiation_style'),
                    research_depth=behavior_cfg.get('research_depth'),
                    ioc_extraction=behavior_cfg.get('ioc_extraction'),
                    report_format=behavior_cfg.get('report_format'),
                    documentation_level=behavior_cfg.get('documentation_level')
                )
                org.agent_behaviors[agent_id] = behavior

        save_organization(org)
        _org = org
        console.print(f"[green]âœ“ Organization '{org.org_name}' initialized from {from_file}[/green]")
        console.print(f"[blue]Created {len(org.desks)} agent desks[/blue]")
        console.print(f"[blue]Loaded {len(org.teams)} teams, {len(org.committees)} committees, {len(org.workflows)} workflows[/blue]")
    else:
        if name is None:
            name = click.prompt('Organization name')
        org = OrganizationStructure(name)
        save_organization(org)
        _org = org
        console.print(f"[green]âœ“ Organization '{name}' initialized[/green]")
        console.print("[yellow]Add agent desks with: agentdesk desk add[/yellow]")


@cli.group()
def desk():
    """Manage agent desks"""
    pass


@desk.command('list')
def desk_list():
    """List all agent desks"""
    org = load_organization()
    
    table = Table(title=f"{org.org_name} - Agent Desks")
    table.add_column("Desk ID", style="cyan")
    table.add_column("Title", style="magenta")
    table.add_column("Role", style="green")
    table.add_column("Level", justify="right")
    table.add_column("Reports To", style="yellow")
    table.add_column("Status", style="blue")
    
    for desk in org.desks.values():
        table.add_row(
            desk.desk_id,
            desk.title,
            desk.role.value,
            str(desk.hierarchy_level),
            desk.reports_to or "-",
            desk.status.value
        )
    
    console.print(table)


@desk.command('add')
@click.option('--desk-id', prompt=True, help='Unique desk identifier')
@click.option('--title', prompt=True, help='Job title')
@click.option('--role', type=click.Choice([r.value for r in AgentRole]), prompt=True)
@click.option('--provider', default='anthropic', help='LLM provider')
@click.option('--model', default='claude-sonnet-4-20250514', help='LLM model')
@click.option('--reports-to', help='Desk ID of supervisor')
@click.option('--level', default=1, help='Hierarchy level')
def desk_add(desk_id, title, role, provider, model, reports_to, level):
    """Add a new agent desk"""
    org = load_organization()
    
    if desk_id in org.desks:
        console.print(f"[red]Error: Desk '{desk_id}' already exists[/red]")
        return
    
    llm_config = LLMConfig(provider=provider, model=model)
    
    desk = AgentDesk(
        desk_id=desk_id,
        title=title,
        role=AgentRole(role),
        llm_config=llm_config,
        hierarchy_level=level,
        reports_to=reports_to
    )
    
    org.add_desk(desk)
    save_organization(org)
    
    console.print(f"[green]âœ“ Added desk '{desk_id}' - {title}[/green]")


@desk.command('info')
@click.argument('desk_id')
def desk_info(desk_id):
    """Show detailed information about a desk"""
    org = load_organization()
    desk = org.get_desk(desk_id)
    
    if not desk:
        console.print(f"[red]Desk '{desk_id}' not found[/red]")
        return
    
    console.print(f"\n[bold cyan]{desk.title}[/bold cyan] ({desk.desk_id})")
    console.print(f"Role: {desk.role.value}")
    console.print(f"Hierarchy Level: {desk.hierarchy_level}")
    console.print(f"Reports To: {desk.reports_to or 'None (top level)'}")
    console.print(f"Status: {desk.status.value}")
    console.print(f"\nLLM Configuration:")
    console.print(f"  Provider: {desk.llm_config.provider}")
    console.print(f"  Model: {desk.llm_config.model}")
    console.print(f"  Temperature: {desk.llm_config.temperature}")
    
    if desk.capabilities:
        console.print(f"\nCapabilities:")
        for cap in desk.capabilities:
            console.print(f"  â€¢ {cap}")
    
    # Show subordinates
    subordinates = org.get_subordinates(desk_id)
    if subordinates:
        console.print(f"\nDirect Reports: {len(subordinates)}")
        for sub in subordinates:
            console.print(f"  â€¢ {sub.title} ({sub.desk_id})")


@cli.group()
def task():
    """Manage tasks"""
    pass


@task.command('create')
@click.option('--title', prompt=True, help='Task title')
@click.option('--description', prompt=True, help='Task description')
@click.option('--priority', type=click.Choice(['low', 'medium', 'high', 'critical']), default='medium')
@click.option('--assign-to', help='Desk ID to assign to')
def task_create(title, description, priority, assign_to):
    """Create a new task"""
    org = load_organization()
    
    priority_map = {
        'low': Priority.LOW,
        'medium': Priority.MEDIUM,
        'high': Priority.HIGH,
        'critical': Priority.CRITICAL
    }
    
    task = org.create_task(
        title=title,
        description=description,
        created_by='cli-user',
        priority=priority_map[priority]
    )
    
    if assign_to:
        desk = org.get_desk(assign_to)
        if desk:
            task.assigned_to = assign_to
            console.print(f"[green]âœ“ Task {task.task_id} created and assigned to {assign_to}[/green]")
        else:
            console.print(f"[yellow]Warning: Desk '{assign_to}' not found. Task created unassigned.[/yellow]")
    else:
        console.print(f"[green]âœ“ Task {task.task_id} created[/green]")
    
    save_organization(org)
    console.print(f"Task ID: {task.task_id}")


@task.command('list')
@click.option('--status', help='Filter by status')
@click.option('--assigned-to', help='Filter by assigned desk')
def task_list(status, assigned_to):
    """List all tasks"""
    org = load_organization()
    
    tasks = list(org.tasks.values())
    
    if status:
        tasks = [t for t in tasks if t.status.value == status]
    if assigned_to:
        tasks = [t for t in tasks if t.assigned_to == assigned_to]
    
    table = Table(title="Tasks")
    table.add_column("Task ID", style="cyan")
    table.add_column("Title", style="magenta")
    table.add_column("Priority", justify="center")
    table.add_column("Status", style="yellow")
    table.add_column("Assigned To", style="green")
    table.add_column("Created", style="blue")
    
    for t in tasks:
        priority_emoji = {
            Priority.LOW: "ðŸŸ¢",
            Priority.MEDIUM: "ðŸŸ¡",
            Priority.HIGH: "ðŸŸ ",
            Priority.CRITICAL: "ðŸ”´"
        }
        
        table.add_row(
            t.task_id,
            t.title[:40] + "..." if len(t.title) > 40 else t.title,
            priority_emoji.get(t.priority, "âšª"),
            t.status.value,
            t.assigned_to or "-",
            t.created_at.strftime("%Y-%m-%d %H:%M")
        )
    
    console.print(table)
    console.print(f"\nTotal: {len(tasks)} tasks")


@task.command('assign')
@click.argument('task_id')
@click.argument('desk_id')
def task_assign(task_id, desk_id):
    """Assign a task to a desk"""
    org = load_organization()
    
    task = org.tasks.get(task_id)
    if not task:
        console.print(f"[red]Task '{task_id}' not found[/red]")
        return
    
    desk = org.get_desk(desk_id)
    if not desk:
        console.print(f"[red]Desk '{desk_id}' not found[/red]")
        return
    
    task.assigned_to = desk_id
    task.status = TaskStatus.PENDING
    save_organization(org)
    
    console.print(f"[green]âœ“ Task {task_id} assigned to {desk.title}[/green]")


@task.command('process')
@click.argument('task_id')
async def task_process_cmd(task_id):
    """Process a task (run the assigned agent)"""
    org = load_organization()
    
    task = org.tasks.get(task_id)
    if not task:
        console.print(f"[red]Task '{task_id}' not found[/red]")
        return
    
    if not task.assigned_to:
        console.print(f"[red]Task is not assigned to any desk[/red]")
        return
    
    desk = org.get_desk(task.assigned_to)
    if not desk:
        console.print(f"[red]Assigned desk '{task.assigned_to}' not found[/red]")
        return
    
    console.print(f"[blue]Processing task {task_id} with {desk.title}...[/blue]")
    
    with console.status("[bold green]Agent working..."):
        result = await desk.process_task(task)
    
    console.print(f"[green]âœ“ Task completed[/green]")
    console.print(f"Status: {task.status.value}")
    console.print(f"Result: {result}")
    
    save_organization(org)


@cli.command()
def org():
    """Display organization chart"""
    org = load_organization()
    
    def build_tree(desk: AgentDesk, tree: Tree):
        subordinates = org.get_subordinates(desk.desk_id)
        for sub in subordinates:
            status_emoji = {
                DeskStatus.ACTIVE: "ðŸŸ¢",
                DeskStatus.IDLE: "âšª",
                DeskStatus.BUSY: "ðŸŸ¡",
                DeskStatus.OFFLINE: "ðŸ”´"
            }
            
            label = f"{sub.title} ({sub.desk_id}) {status_emoji.get(sub.status, '')}"
            branch = tree.add(label)
            build_tree(sub, branch)
    
    # Find root desks (those with no supervisor)
    roots = [d for d in org.desks.values() if not d.reports_to]
    
    main_tree = Tree(f"[bold cyan]{org.org_name}[/bold cyan]")
    
    for root in roots:
        status_emoji = {
            DeskStatus.ACTIVE: "ðŸŸ¢",
            DeskStatus.IDLE: "âšª",
            DeskStatus.BUSY: "ðŸŸ¡",
            DeskStatus.OFFLINE: "ðŸ”´"
        }
        
        label = f"{root.title} ({root.desk_id}) {status_emoji.get(root.status, '')}"
        branch = main_tree.add(label)
        build_tree(root, branch)
    
    console.print(main_tree)
    console.print(f"\nTotal desks: {len(org.desks)}")
    console.print(f"Total tasks: {len(org.tasks)}")


@cli.command()
def run():
    """Start interactive task processing loop"""
    org = load_organization()
    
    console.print(f"[bold green]AgentDesk Task Processor[/bold green]")
    console.print(f"Organization: {org.org_name}")
    console.print(f"Desks: {len(org.desks)}, Tasks: {len(org.tasks)}\n")
    
    while True:
        # Find pending tasks
        pending = [t for t in org.tasks.values() if t.status == TaskStatus.PENDING and t.assigned_to]
        
        if not pending:
            console.print("[yellow]No pending tasks. Use 'task create' to add tasks.[/yellow]")
            break
        
        console.print(f"\n[cyan]Found {len(pending)} pending tasks:[/cyan]")
        for i, task in enumerate(pending[:5], 1):
            console.print(f"{i}. {task.task_id}: {task.title} â†’ {task.assigned_to}")
        
        choice = console.input("\n[bold]Process which task? (number or 'q' to quit): [/bold]")
        
        if choice.lower() == 'q':
            break
        
        try:
            idx = int(choice) - 1
            if 0 <= idx < len(pending):
                task = pending[idx]
                asyncio.run(task_process_cmd.callback(task.task_id))
            else:
                console.print("[red]Invalid choice[/red]")
        except ValueError:
            console.print("[red]Invalid input[/red]")


if __name__ == '__main__':
    # Wrap async commands
    import sys
    if len(sys.argv) > 1 and sys.argv[1] == 'task' and len(sys.argv) > 2 and sys.argv[2] == 'process':
        # Run async command
        asyncio.run(cli())
    else:
        cli()
